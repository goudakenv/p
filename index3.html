<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>ãƒ«ãƒ¼ãƒ ã‚·ã‚§ã‚¢æ¸…ç®—ãƒ¡ãƒ¢ï¼ˆå±¥æ­´ä»˜ãï¼‰</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            deleteDoc,
            doc,
            query,
            orderBy,
            limit
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3QzOBknuvpVy1rcl9o2PJIsKjzcH6-Ko",
            authDomain: "loginconnect-b3963.firebaseapp.com",
            projectId: "loginconnect-b3963",
            storageBucket: "loginconnect-b3963.appspot.com",
            messagingSenderId: "362875108198",
            appId: "1:362875108198:web:e94198275cbb42d6aca6a7",
            measurementId: "G-THFPS2MKYJ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.firebaseDB = db;

        // ç›´è¿‘ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆ
        async function setLastDataToForm() {
            const q = query(collection(db, "roomshare_history"), orderBy("timestamp", "desc"), limit(1));
            const snapshot = await getDocs(q);
            if (!snapshot.empty) {
                const data = snapshot.docs[0].data();
                document.getElementById("date").value = data.date || "";
                document.getElementById("rent").value = data.rent || "";
                document.getElementById("rentDate").value = data.rentDate || "";
                document.getElementById("electric").value = data.electric || "";
                document.getElementById("electricDate").value = data.electricDate || "";
                document.getElementById("gas").value = data.gas || "";
                document.getElementById("gasDate").value = data.gasDate || "";
                document.getElementById("water").value = data.water || "";
                document.getElementById("waterDate").value = data.waterDate || "";
                document.getElementById("waterPayer").value = data.waterPayer || "suke";
            }
        }

        // æ¸…ç®—å±¥æ­´ã®èª­ã¿è¾¼ã¿è¡¨ç¤º
        async function loadHistory() {
            const historyList = document.getElementById("historyList");
            historyList.innerHTML = "";
            const snapshot = await getDocs(query(collection(db, "roomshare_history"), orderBy("timestamp", "desc")));
            snapshot.forEach(docSnap => {
                const d = docSnap.data();

                // æ”¯æ‰•ã„å·®é¡è¨ˆç®—ï¼ˆã‚¹ã‚±â†’ãƒŠãƒ„ã«æ”¯æ‰•ã†é¡ï¼‰
                const total = d.rent + d.electric + d.gas + d.water;
                const perPerson = total / 2;

                // ã‚¹ã‚±ãŒæ”¯æ‰•ã£ãŸåˆè¨ˆï¼ˆã‚¬ã‚¹ï¼‹æ°´é“ãŒã‚¹ã‚±æ‰•ã„ã®å ´åˆï¼‰
                const sukePaid = d.gas + (d.waterPayer === "suke" ? d.water : 0);

                // ãƒŠãƒ„ãŒæ”¯æ‰•ã£ãŸåˆè¨ˆï¼ˆå®¶è³ƒï¼‹é›»æ°—ï¼‹æ°´é“ãŒãƒŠãƒ„æ‰•ã„ã®å ´åˆï¼‰
                const natsuPaid = d.rent + d.electric + (d.waterPayer === "natsu" ? d.water : 0);

                // ã‚¹ã‚±ãŒãƒŠãƒ„ã«æ‰•ã†ã¹ãé‡‘é¡ = ãƒŠãƒ„ãŒæ‰•ã†ã¹ãåŠé¡ - ã‚¹ã‚±ãŒæ—¢ã«æ‰•ã£ãŸé‡‘é¡
                // ï¼ˆå·®é¡ãŒæ­£ã®å ´åˆã¯ã‚¹ã‚±ãŒãƒŠãƒ„ã«æ”¯æ‰•ã†ã€‚è² ãªã‚‰ãƒŠãƒ„ãŒã‚¹ã‚±ã«æ”¯æ‰•ã†ãŒä»Šå›ã¯ã‚¹ã‚±â†’ãƒŠãƒ„ã®ã¿è¡¨ç¤ºï¼‰
                const diff = perPerson - sukePaid;

                const diffStr = diff > 0 ? `ã‚¹ã‚±ã¯ãƒŠãƒ„ã« ${diff.toFixed(0)} å††æ”¯æ‰•ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚` : "ã‚¹ã‚±ã¯æ”¯æ‰•ã„ä¸è¦ï¼ˆãƒŠãƒ„ã®æ–¹ãŒå¤šãæ‰•ã£ã¦ã„ã¾ã™ï¼‰";

                const div = document.createElement("div");
                div.className = "history-item-details";
                div.innerHTML = `
                    <strong>${d.date}</strong><br>
                    å®¶è³ƒï¼ˆãƒŠãƒ„ï¼‰ï¼š${d.rent}å††ï¼ˆ${d.rentDate}ï¼‰<br>
                    é›»æ°—ï¼ˆãƒŠãƒ„ï¼‰ï¼š${d.electric}å††ï¼ˆ${d.electricDate}ï¼‰<br>
                    ã‚¬ã‚¹ï¼ˆã‚¹ã‚±ï¼‰ï¼š${d.gas}å††ï¼ˆ${d.gasDate}ï¼‰<br>
                    æ°´é“ï¼ˆ${d.waterPayer === "suke" ? "ã‚¹ã‚±" : "ãƒŠãƒ„"}ï¼‰ï¼š${d.water}å††ï¼ˆ${d.waterDate}ï¼‰<br>
                    <b>åˆè¨ˆï¼š${total}å†† / 1äººåˆ†ï¼š${perPerson.toFixed(0)}å††</b><br>
                    <b>${diffStr}</b>
                `;
                historyList.appendChild(div);
            });
        }

        // è¨ˆç®—ï¼†Firestoreã«ä¿å­˜
        document.getElementById("calculateBtn").addEventListener("click", async () => {
            const date = document.getElementById("date").value;
            if (!date) {
                alert("æ¸…ç®—æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            // å…¥åŠ›å€¤å–å¾—
            const rent = Number(document.getElementById("rent").value) || 0;
            const rentDate = document.getElementById("rentDate").value || "";
            const electric = Number(document.getElementById("electric").value) || 0;
            const electricDate = document.getElementById("electricDate").value || "";
            const gas = Number(document.getElementById("gas").value) || 0;
            const gasDate = document.getElementById("gasDate").value || "";
            const water = Number(document.getElementById("water").value) || 0;
            const waterDate = document.getElementById("waterDate").value || "";
            const waterPayer = document.getElementById("waterPayer").value;

            // ã‚¬ã‚¹ã¯ã‚¹ã‚±ãŒå…¨é¡æ”¯æ‰•ã„å›ºå®š
            // é›»æ°—ã¯ãƒŠãƒ„ãŒå…¨é¡æ”¯æ‰•ã„å›ºå®š
            // æ°´é“ã¯é¸æŠã—ãŸæ”¯æ‰•è€…

            // åˆè¨ˆè¨ˆç®—
            const total = rent + electric + gas + water;
            const perPerson = total / 2;

            // ã‚¹ã‚±ã®æ”¯æ‰•ã„åˆè¨ˆï¼ˆã‚¬ã‚¹ï¼‹æ°´é“ãŒã‚¹ã‚±ã®ã¨ãï¼‰
            const sukePaid = gas + (waterPayer === "suke" ? water : 0);

            // ãƒŠãƒ„ã®æ”¯æ‰•ã„åˆè¨ˆï¼ˆå®¶è³ƒï¼‹é›»æ°—ï¼‹æ°´é“ãŒãƒŠãƒ„ã®ã¨ãï¼‰
            const natsuPaid = rent + electric + (waterPayer === "natsu" ? water : 0);

            // å·®é¡ï¼ˆã‚¹ã‚±ãŒãƒŠãƒ„ã«æ‰•ã†é‡‘é¡ï¼‰
            const diff = perPerson - sukePaid;

            // Firestoreã«ä¿å­˜
            const data = {
                date,
                rent,
                rentDate,
                electric,
                electricDate,
                gas,
                gasDate,
                water,
                waterDate,
                waterPayer,
                timestamp: new Date(),
                total,
                perPerson,
                diff
            };

            await addDoc(collection(db, "roomshare_history"), data);
            await setLastDataToForm();
            await loadHistory();

            // è¨ˆç®—çµæœè¡¨ç¤º
            const resultDiv = document.getElementById("result");
            if (diff > 0) {
                resultDiv.textContent = `ã‚¹ã‚±ã¯ãƒŠãƒ„ã« ${diff.toFixed(0)} å††æ”¯æ‰•ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`;
            } else if (diff < 0) {
                resultDiv.textContent = `ãƒŠãƒ„ã¯ã‚¹ã‚±ã« ${Math.abs(diff).toFixed(0)} å††æ”¯æ‰•ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`;
            } else {
                resultDiv.textContent = "æ”¯æ‰•ã„ã¯å‡ç­‰ã§ã™ã€‚";
            }
            resultDiv.style.display = "block";
        });

        // å±¥æ­´å‰Šé™¤
        window.clearHistory = async () => {
            if (!confirm("å±¥æ­´ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            const snapshot = await getDocs(collection(db, "roomshare_history"));
            const deletions = snapshot.docs.map(docSnap => deleteDoc(doc(db, "roomshare_history", docSnap.id)));
            await Promise.all(deletions);
            await loadHistory();

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById("result").style.display = "none";
            document.getElementById("date").value = "";
            document.getElementById("rent").value = "";
            document.getElementById("rentDate").value = "";
            document.getElementById("electric").value = "";
            document.getElementById("electricDate").value = "";
            document.getElementById("gas").value = "";
            document.getElementById("gasDate").value = "";
            document.getElementById("water").value = "";
            document.getElementById("waterDate").value = "";
            document.getElementById("waterPayer").value = "suke";
        }

        window.addEventListener("DOMContentLoaded", async () => {
            await setLastDataToForm();
            await loadHistory();
        });

    </script>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            max-width: 750px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input,
        select {
            width: 100%;
            padding: 6px;
            font-size: 1em;
            margin-top: 5px;
        }

        button {
            margin-top: 20px;
            padding: 10px;
            font-size: 1em;
            cursor: pointer;
        }

        .row {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .row label {
            flex: 1;
            min-width: 200px;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            background: #cce;
            border: 1px solid #99c;
            font-weight: bold;
        }

        .history {
            margin-top: 30px;
        }

        .history-item-details {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #eef;
            border: 1px solid #99c;
            white-space: pre-wrap;
        }
    </style>
</head>

<body>
    <h1>ãƒ«ãƒ¼ãƒ ã‚·ã‚§ã‚¢æ¸…ç®—ãƒ¡ãƒ¢ï¼ˆå±¥æ­´ä¿å­˜å¯¾å¿œï¼‰</h1>

    <label>æ¸…ç®—æ—¥<input type="date" id="date" /></label>

    <div class="row">
        <label>å®¶è³ƒï¼ˆãƒŠãƒ„ï¼‰<input type="number" id="rent" /></label>
        <label>æ”¯æ‰•æ—¥<input type="date" id="rentDate" /></label>
    </div>

    <div class="row">
        <label>é›»æ°—ä»£ï¼ˆãƒŠãƒ„ï¼‰<input type="number" id="electric" /></label>
        <label>æ”¯æ‰•æ—¥<input type="date" id="electricDate" /></label>
    </div>

    <div class="row">
        <label>ã‚¬ã‚¹ä»£ï¼ˆã‚¹ã‚±ï¼‰<input type="number" id="gas" /></label>
        <label>æ”¯æ‰•æ—¥<input type="date" id="gasDate" /></label>
    </div>

    <div class="row">
        <label>æ°´é“ä»£<input type="number" id="water" /></label>
        <label>æ”¯æ‰•æ—¥<input type="date" id="waterDate" /></label>
    </div>

    <label>æ°´é“ã®æ”¯æ‰•è€…
        <select id="waterPayer">
            <option value="suke">ã‚¹ã‚±</option>
            <option value="natsu">ãƒŠãƒ„</option>
        </select>
    </label>

    <button id="calculateBtn">è¨ˆç®—ã—ã¦å±¥æ­´ã«è¿½åŠ </button>
    <button onclick="clearHistory()" style="background-color:#fdd; margin-left:10px;">å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>

    <div id="result" style="display:none;"></div>

    <div class="history">
        <h2>ğŸ“‚ æ¸…ç®—å±¥æ­´</h2>
        <div id="historyList"></div>
    </div>
</body>

</html>