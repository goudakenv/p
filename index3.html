<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>ãƒ«ãƒ¼ãƒ ã‚·ã‚§ã‚¢æ¸…ç®—ãƒ¡ãƒ¢ï¼ˆå±¥æ­´ä»˜ãï¼‰</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            max-width: 750px;
        }

        label {
            display: block;
            margin-top: 10px;
        }

        input,
        select {
            width: 100%;
            padding: 6px;
            font-size: 1em;
            margin-top: 5px;
        }

        button {
            margin-top: 20px;
            padding: 10px;
            font-size: 1em;
            cursor: pointer;
        }

        .result,
        .history-item-details {
            margin-top: 10px;
            padding: 10px;
            background-color: #eef;
            border: 1px solid #99c;
        }

        .history {
            margin-top: 30px;
        }

        .history-item {
            margin-bottom: 10px;
        }

        .history-title {
            font-weight: bold;
            cursor: pointer;
            background: #ddf;
            padding: 5px;
        }

        .history-buttons {
            margin-top: 10px;
        }

        .history-buttons button {
            margin-right: 10px;
        }
    </style>
</head>

<body>
    <h1>ãƒ«ãƒ¼ãƒ ã‚·ã‚§ã‚¢æ¸…ç®—ãƒ¡ãƒ¢ï¼ˆå±¥æ­´ä¿å­˜å¯¾å¿œï¼‰</h1>

    <label>æ¸…ç®—æ—¥<input type="text" id="date" placeholder="ä¾‹ï¼š2025/6/22" /></label>
    <label>å®¶è³ƒï¼ˆãƒŠãƒ„ï¼‰<input type="number" id="rent" value="104683" /></label>
    <label>å®¶è³ƒæ”¯æ‰•æ—¥<input type="text" id="rentDate" placeholder="ä¾‹ï¼š6/12" /></label>

    <label>é›»æ°—ä»£ï¼ˆãƒŠãƒ„ï¼‰<input type="number" id="electric" placeholder="ä¾‹ï¼š3335" /></label>
    <label>é›»æ°—æ”¯æ‰•æ—¥<input type="text" id="electricDate" placeholder="ä¾‹ï¼š6/12" /></label>

    <label>ã‚¬ã‚¹ä»£ï¼ˆã‚¹ã‚±ï¼‰<input type="number" id="gas" placeholder="ä¾‹ï¼š3535" /></label>
    <label>ã‚¬ã‚¹æ”¯æ‰•æ—¥<input type="text" id="gasDate" placeholder="ä¾‹ï¼š6/10" /></label>

    <label>æ°´é“ä»£ï¼ˆèª°ã‹ãŒæ‰•ã£ãŸï¼‰<input type="number" id="water" placeholder="ä¾‹ï¼š4642" /></label>
    <label>æ°´é“æ”¯æ‰•æ—¥<input type="text" id="waterDate" placeholder="ä¾‹ï¼š6/2" /></label>
    <label>æ°´é“ã®æ”¯æ‰•è€…
        <select id="waterPayer">
            <option value="suke">ã‚¹ã‚±</option>
            <option value="natsu">ãƒŠãƒ„</option>
        </select>
    </label>

    <button id="calculateBtn" onclick="calculate()">è¨ˆç®—ã—ã¦å±¥æ­´ã«è¿½åŠ </button>
    <button onclick="clearHistory()" style="background-color:#fdd; margin-left:10px;">å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>

    <div class="result" id="result" style="display:none;"></div>

    <div class="history">
        <h2>ğŸ—‚ æ¸…ç®—å±¥æ­´</h2>
        <div id="historyList"></div>
    </div>

    <script>
        const historyList = document.getElementById("historyList");
        const HISTORY_KEY = "roomshare-history";

        // ç·¨é›†ä¸­ã®å±¥æ­´ID (nullãªã‚‰æ–°è¦)
        let editingId = null;

        function loadHistory() {
            const saved = localStorage.getItem(HISTORY_KEY);
            if (saved) {
                const items = JSON.parse(saved);
                items.forEach((item) => addHistoryItem(item, false));
            }
        }

        function saveAllHistory(items) {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(items));
        }

        function saveHistoryItem(data) {
            const saved = localStorage.getItem(HISTORY_KEY);
            const items = saved ? JSON.parse(saved) : [];

            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãªã‚‰æ›´æ–°ã€æ–°è¦ãªã‚‰è¿½åŠ 
            if (data._id) {
                const idx = items.findIndex((i) => i._id === data._id);
                if (idx >= 0) {
                    items[idx] = data;
                } else {
                    items.unshift(data);
                }
            } else {
                data._id = "history-" + Date.now() + "-" + Math.random().toString(16).slice(2);
                items.unshift(data);
            }

            saveAllHistory(items);
        }

        function clearHistory() {
            if (confirm("æœ¬å½“ã«å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem(HISTORY_KEY);
                historyList.innerHTML = "";
                editingId = null;
                clearForm();
                document.getElementById("result").style.display = "none";
            }
        }

        function calculate() {
            const data = {
                date: document.getElementById("date").value || "(æ—¥ä»˜æœªè¨˜å…¥)",
                rent: Number(document.getElementById("rent").value) || 0,
                rentDate: document.getElementById("rentDate").value || "-",
                electric: Number(document.getElementById("electric").value) || 0,
                electricDate: document.getElementById("electricDate").value || "-",
                gas: Number(document.getElementById("gas").value) || 0,
                gasDate: document.getElementById("gasDate").value || "-",
                water: Number(document.getElementById("water").value) || 0,
                waterDate: document.getElementById("waterDate").value || "-",
                waterPayer: document.getElementById("waterPayer").value,
            };

            const totalShared = data.rent + data.electric;
            const halfShared = totalShared / 2;
            const halfGas = data.gas / 2;
            const halfWater = data.water / 2;

            let sukeToNatsu = halfShared - halfGas;
            if (data.waterPayer === "suke") {
                sukeToNatsu -= halfWater;
            } else {
                sukeToNatsu += halfWater;
            }

            data.resultHTML = `
        ğŸ“… <strong>æ¸…ç®—æ—¥ï¼š</strong>${data.date}<br>
        âœ… å®¶è³ƒï¼š${data.rent.toLocaleString()}å††ï¼ˆæ”¯æ‰•æ—¥ï¼š${data.rentDate}ï¼‰<br>
        âœ… é›»æ°—ï¼š${data.electric.toLocaleString()}å††ï¼ˆæ”¯æ‰•æ—¥ï¼š${data.electricDate}ï¼‰<br>
        âœ… ã‚¬ã‚¹ï¼š${data.gas.toLocaleString()}å††ï¼ˆæ”¯æ‰•æ—¥ï¼š${data.gasDate}ï¼‰ â†’ æŠ˜åŠï¼š${halfGas.toLocaleString()}å††<br>
        âœ… æ°´é“ï¼š${data.water.toLocaleString()}å††ï¼ˆæ”¯æ‰•æ—¥ï¼š${data.waterDate} / æ”¯æ‰•è€…ï¼š${data.waterPayer === "suke" ? "ã‚¹ã‚±" : "ãƒŠãƒ„"}ï¼‰ â†’ æŠ˜åŠï¼š${halfWater.toLocaleString()}å††<br>
        <hr>
        ğŸ’° ã‚¹ã‚± â†’ ãƒŠãƒ„ã«æ”¯æ‰•ã†é‡‘é¡ï¼š<strong>${sukeToNatsu.toLocaleString()}å††</strong>
      `;

            // ç·¨é›†ä¸­ãªã‚‰æ›´æ–°ã€æ–°è¦ãªã‚‰è¿½åŠ 
            if (editingId) {
                data._id = editingId;
                updateHistoryItem(data);
                editingId = null;
                document.getElementById("calculateBtn").textContent = "è¨ˆç®—ã—ã¦å±¥æ­´ã«è¿½åŠ ";
            } else {
                addHistoryItem(data, true);
            }

            // çµæœè¡¨ç¤º
            document.getElementById("result").innerHTML = data.resultHTML;
            document.getElementById("result").style.display = "block";

            clearForm();
        }

        function addHistoryItem(data, save = true) {
            // ä¿å­˜æ™‚ã¯IDç”Ÿæˆ
            if (!data._id) {
                data._id = "history-" + Date.now() + "-" + Math.random().toString(16).slice(2);
            }

            // å±¥æ­´è¦ç´ ä½œæˆ
            const historyItem = document.createElement("div");
            historyItem.className = "history-item";
            historyItem.id = data._id;

            historyItem.innerHTML = `
        <div class="history-title" onclick="toggleDetails('${data._id}-details')">ğŸ“… ${data.date} ã®æ¸…ç®— â–¼</div>
        <div id="${data._id}-details" class="history-item-details" style="display:none;">
          ${data.resultHTML}
          <div class="history-buttons">
            <button onclick="editHistoryItem('${data._id}')">ç·¨é›†</button>
            <button onclick="deleteHistoryItem('${data._id}')">å‰Šé™¤</button>
          </div>
        </div>
      `;

            historyList.prepend(historyItem);

            if (save) {
                saveHistoryItem(data);
            }
        }

        function updateHistoryItem(data) {
            // å±¥æ­´ä¸€è¦§ã‚’æ›´æ–°
            const saved = localStorage.getItem(HISTORY_KEY);
            let items = saved ? JSON.parse(saved) : [];

            const index = items.findIndex((i) => i._id === data._id);
            if (index >= 0) {
                items[index] = data;
                saveAllHistory(items);

                // è¡¨ç¤ºã‚‚æ›´æ–°
                const el = document.getElementById(data._id);
                if (el) {
                    el.querySelector(".history-title").textContent = `ğŸ“… ${data.date} ã®æ¸…ç®— â–¼`;
                    el.querySelector(`#${data._id}-details`).innerHTML = `
                    ${data.resultHTML}
                    <div class="history-buttons">
                        <button onclick="editHistoryItem('${data._id}')">ç·¨é›†</button>
                        <button onclick="deleteHistoryItem('${data._id}')">å‰Šé™¤</button>
                    </div>
                    `;
                }
            }
        }

        function deleteHistoryItem(id) {
            if (!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

            // ç”»é¢ã‹ã‚‰å‰Šé™¤
            const el = document.getElementById(id);
            if (el) el.remove();

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚‚å‰Šé™¤
            const saved = localStorage.getItem(HISTORY_KEY);
            if (saved) {
                let items = JSON.parse(saved);
                items = items.filter((item) => item._id !== id);
                saveAllHistory(items);
            }

            // ç·¨é›†ä¸­ã®å‰Šé™¤ã ã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
            if (editingId === id) {
                editingId = null;
                clearForm();
                document.getElementById("calculateBtn").textContent = "è¨ˆç®—ã—ã¦å±¥æ­´ã«è¿½åŠ ";
                document.getElementById("result").style.display = "none";
            }
        }

        function editHistoryItem(id) {
            const saved = localStorage.getItem(HISTORY_KEY);
            if (!saved) return alert("å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

            const items = JSON.parse(saved);
            const item = items.find((i) => i._id === id);
            if (!item) return alert("è©²å½“å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById("date").value = item.date || "";
            document.getElementById("rent").value = item.rent || 0;
            document.getElementById("rentDate").value = item.rentDate || "";
            document.getElementById("electric").value = item.electric || 0;
            document.getElementById("electricDate").value = item.electricDate || "";
            document.getElementById("gas").value = item.gas || 0;
            document.getElementById("gasDate").value = item.gasDate || "";
            document.getElementById("water").value = item.water || 0;
            document.getElementById("waterDate").value = item.waterDate || "";
            document.getElementById("waterPayer").value = item.waterPayer || "suke";

            editingId = id;

            document.getElementById("calculateBtn").textContent = "æ›´æ–°ã—ã¦ä¿å­˜";
            document.getElementById("result").style.display = "none";

            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãƒ•ã‚©ãƒ¼ãƒ ã¸èª˜å°ï¼ˆãŠå¥½ã¿ã§ï¼‰
            window.scrollTo({ top: 0, behavior: "smooth" });
        }

        function clearForm() {
            document.getElementById("date").value = "";
            document.getElementById("rent").value = "";
            document.getElementById("rentDate").value = "";
            document.getElementById("electric").value = "";
            document.getElementById("electricDate").value = "";
            document.getElementById("gas").value = "";
            document.getElementById("gasDate").value = "";
            document.getElementById("water").value = "";
            document.getElementById("waterDate").value = "";
            document.getElementById("waterPayer").value = "suke";
        }

        function toggleDetails(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.style.display = el.style.display === "none" ? "block" : "none";
        }

        window.onload = loadHistory;
    </script>
</body>

</html>